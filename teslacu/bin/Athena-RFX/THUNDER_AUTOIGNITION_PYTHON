#!/bin/bash
ncpus=36
mpiprocs=32
mpi=mpiexec_mpt
analysis=autoignition_basics_serial

#                         0             1             2             3             4             5             6             7)
###                 THUNDER       THUNDER       THUNDER       THUNDER       THUNDER       THUNDER       THUNDER       THUNDER)
K=(                     256           256           256           256           256           256           256           256)
N=(                     512           512           512           512           512           512           512           512)
config=(              exact         exact         exact         exact         exact         exact         exact         exact)

nproc=(                 512           512           512           512           512           512           512           512)
walltime=(         04:00:00      04:00:00      04:00:00      04:00:00      04:00:00      04:00:00      04:00:00      04:00:00)
queue=(            frontier      frontier      frontier      frontier      frontier      frontier      frontier      frontier)

rs=(                      1             1             1             1             1             1             1             1)
re=(                      4             4             4             4             4             4             4             2)
rint=(                    1             1             1             1             1             1             1             1)

ts=(                      1             2             4             5             6             7             7             7)
te=(                     10            20            40            50            60            70            70            70)
tint=(                    1             2             4             5             6             7             7             7)

rvtk=(                  0.1           0.1           0.1           0.1           0.1           0.1           0.1           0.1)
rstrt=(                   6             6             5             5             5             5             5             5)
rrctn=(                   6             6             5             5             5             5             5             5)
rlimi=(                   7             8             9            10            11            12            12            12)
rlimr=(                  14            14            14            14            14            14            14            14)
rdrv=(                 0.25          0.25          0.25          0.25          0.25          0.25          0.25          0.25)

iIS=(                     4             4             4             4             4             4             4             4)
kexp=(                 -1.0          -1.0          -1.0          -1.0          -1.0          -1.0          -1.0          -1.0)
kpi=(                   128           128           128           128           128           128           128           128)

mach=(                  0,1           0,2           0,3           0,4           0,5           0,6           0,8           1,0)
L=(              1.1758e-01    5.9245e-02    3.9800e-02    2.9850e-02    2.3698e-02    1.9748e-02    1.4583e-02    1.1576e-02)
reps=(           1.1048e+09    1.7138e+10    8.4144e+10    2.6594e+11    6.6947e+11    1.3882e+12    4.6681e+12    1.1760e+13)
reIC=(           2.1954e+04    6.2095e+04    1.1408e+05    1.7563e+05    2.4545e+05    3.2265e+05    4.9676e+05    3.4712e+05)
ted=(          0.0000070549  0.0000017774  0.0000007960  0.0000004478  0.0000002844  0.0000001975  0.0000001094  0.0000000695)
tauK=(         0.0000005924  0.0000001504  0.0000000679  0.0000000382  0.0000000241  0.0000000167  0.0000000091  0.0000000057)
Ti=(                  997.4         989.6         976.6         958.4         935.0         906.4         833.6         740.1)
Pi=(              3368720.7     3342382.8     3298486.3     3237031.1     3158017.4     3061445.0     2815624.5     2499569.5)

gamma=(                 1.3           1.3           1.3           1.3           1.3           1.3           1.3           1.3)
coef=(              3.41e-6       3.41e-6       3.41e-6       3.41e-6       3.41e-6       3.41e-6       3.41e-6       3.41e-6)
MolW=(                 26.8          26.8          26.8          26.8          26.8          26.8          26.8          26.8)
Q=(                    45.0          45.0          45.0          45.0          45.0          45.0          45.0          45.0)
A=(                 1.0e+13       1.0e+13       1.0e+13       1.0e+13       1.0e+13       1.0e+13       1.0e+13       1.0e+13)
qChem=(                25.0          25.0          25.0          25.0          25.0          25.0          25.0          25.0)
R=(               3102410.4     3102410.4     3102410.4     3102410.4     3102410.4     3102410.4     3102410.4     3102410.4)

for i in 5 3 1 6 4 2 0 7; do #${!N[*]}; do

ROOT=M${M[i]}_K${K[i]}_N${N[i]}_${config[i]}
BIN=/workspace/ctowery/autoignition/ideal_arrh/M${M[i]}_K${K[i]}_${config[i]}/bin/
IDIR=/workspace/ctowery/autoignition/ideal_arrh/M${M[i]}_K${K[i]}_${config[i]}/data/${ROOT}/
ODIR=/workspace/ctowery/autoignition/ideal_arrh/analysis/2017_05_01/${ROOT}/

nnode=$(( nproc[i]/mpiprocs + ( (nproc[i] % mpiprocs)>0 ) ))

mkdir -p ${BIN}
cd ${BIN}
cp ~/analysis_codes/compressible_dns/*.py ./

rm -f L${N[i]}.pbs
cat > L${N[i]}.pbs <<EOD
#!/bin/bash
#PBS -A AFMNG40292YF2
#PBS -j oe
#PBS -l walltime=${walltime[i]}
#PBS -l select=$nnode:ncpus=$ncpus:mpiprocs=$mpiprocs
#PBS -q ${queue[i]}
#PBS -N Py_M${M[i]}_K${K[i]}

ulimit -s unlimited
module load costinit python/intel/2.7.9 scipy/intel/0.15.1 mpi4py/intel/sgimpt/2.0.0

JOBID=\`echo \${PBS_JOBID} | cut -d '.' -f 1\`
cd \$PBS_O_WORKDIR

$mpi -n ${nproc[i]} python ${analysis}.py -i ${IDIR} -o ${ODIR} -p ${ROOT} \
-N ${N[i]} -g ${gamma[i]} -L ${L[i]} -R ${R[i]} -r ${rs[i]}:${re[i]}:${rint[i]} \
-t ${ts[i]}:${te[i]}:${tint[i]} 2>&1 | tee \${JOBID}.out

EOD

echo "PBS -l select=$nnode:ncpus=$ncpus:mpiprocs=$mpiprocs"
echo "$mpi -n ${nproc[i]} python ${analysis}.py -i ${IDIR} -o ${ODIR} -p ${ROOT} \
-N ${N[i]} -g ${gamma[i]} -L ${L[i]} -R ${R[i]} -r ${rs[i]}:${re[i]}:${rint[i]} \
-t ${ts[i]}:${te[i]}:${tint[i]} 2>&1 | tee \${JOBID}.out"

qsub N${N[i]}.pbs

done #end of for loop
